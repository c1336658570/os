# 现代操作系统：原理与实现

## 系统虚拟化

虚拟化的优势：

1. 服务器整合：传统数据中心服务器的CPU平均利用率仅为约20％，通过在—台物理服务器上整合多个虚拟机，可有效提高资源利用率，降低成本。同时，基于用户“错峰使用”的特性，甚至可以使虚拟机的资源总数超过物理主机的资源总数’即云计算中的“超售”。
2. 虚拟机管理：相比于传统服务器，虚拟机的管理简化了许多。例如，通过软件接口，可以在短时间内创建数千台虚拟机并安装操作系统环境，也可以直接对虚拟机进行复制、备份、快照、销毁等操作。
3. 虚拟机热迁移：虚拟机监控器可将正在运行的虚拟机从一台物理服务器迁移到另一台物理服务器上，整个过程无须停机或重启。热迁移不但能解决物理服务器维修导致的服务暂停问题，还能更好地实现全局的负载均衡。
4. 虚拟机安全自省：虚拟机自省（Virtual Machine Introspection，VMI）技术允许虚拟机监控器从外部检查虚拟机内部状态是否正确。以此判断虚拟机是否遭到人侵，例如被攻击者植入Rootkit。

### 系统虚拟化技术概述

#### 系统虚拟化及其组成部分

系统虚拟化技术的核心是虚拟机监控器，一般运行在CPU的最高特权级，直接控制着硬件，并为上层软件提供虚拟的硬件接口。

![2022-10-17_09-09](/home/cccmmf/操作系统/现代操作系统：原理与实现/chap11系统虚拟化/2022-10-17_09-09.png)

虚拟化技术主要的三个方面：CPU虚拟化、内存虚拟化和I/O虚拟化。

- CPU虚拟化：指虚拟机监控器为虚拟机提供虚拟处理器（virtual CPU，vCPU）的抽象并执行其指令的过程。
- 内存虚拟化：指为虚拟机提供虚拟的物理地址空间。
- I/O虚拟化：指为虚拟机提供虚拟的I/O设备支持。

#### 虚拟机监控器的类型

高效系统虚拟化需要满足以下三个条件：

1. 拟机监控器为虚拟机内的程序提供与该程序的目标执行硬件的接口完全一样的硬件接口。这意味着。所有能在物理主机上运行的程序，都应该能够运行在虚拟机上。
2. 虚拟机运行的性能只比在无虚拟化的情况下略微差一点。
3. 虚拟机监控器控制所有物理系统资源。例如CPU、内存、存储、网络等资源。换句话说，虚拟机不能使用任何不属于它的资源。虚拟机监控器也可以在任何时候回收资源。

![2022-10-17_09-17](/home/cccmmf/操作系统/现代操作系统：原理与实现/chap11系统虚拟化/2022-10-17_09-17.png)

Type-1代表：Xen，Type-2代表QEMU。

#### CPU虚拟化



























