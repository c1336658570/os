## chap9中断和动态时钟显示

中断就是打断处理器当前的执行流程，去执行另外一些和当前工作不相干的指令，执行完之后，还可以返回到原来的程序流程继续执行。

### 外部硬中断

外部设备出错，有数据要传送（比如，从网络中接收到一个针对当前主机的数据包），或者处理器交给它的事情处理完了（比如，打印完成）。

外部硬件中断通过两个信号线引入处理器内部，NMI和INTR

![屏幕截图 2023-03-13 200918](/home/cccmmf/操作系统/x86/chap9/屏幕截图 2023-03-13 200918.png)

#### 非屏蔽中断

非屏蔽中断，NMI（Non Maskable Interrupt）。几乎所有触发NMI的事件对处理器来说都是致命的。在实模式下，NMI被赋予统一终端号2。一旦发生2号中断，处理器和软件系统通常放弃继续工作的念头，也不会试图纠正已经发生的问题和错误，很可能只是由软件系统给出一个提示信息。

#### 可屏蔽中断

这类中断由两个特点，其一是数量很多（因为有很多外设），第二是可以被屏蔽。通过INTR引脚进入处理器内部。处理器不可能为每个中断源都提供一个引脚，而且处理器一次只能处理一个中断，所以有了中断控制器。Intel处理器允许256个中断，0~255,8259中断控制器负责其中15个，但中断号并不固定。该中断控制器芯片有自己的端口号，可以像访问外设那样用in和out指令改变他的状态，包括各引脚的中断号，所以它又叫可编程中断控制器（Programmable Interrupt Controller，PIC）。

![屏幕截图 2023-03-14 221124](/home/cccmmf/操作系统/x86/chap9/屏幕截图 2023-03-14 221124.png) 

每片8259只有8个引脚，所以需要两个8259芯片来提供15个中断信号。主片引脚0（IR0）接系统定时器/计数器芯片。从片引脚0（IR0）接实时时钟芯片RTC。

8259内部有中断屏蔽寄存器（Interrupt Mask Register，IMR），这是8位寄存器，对应芯片8个输入引脚，0表示允许中断信号通过，1表示阻断。8259芯片是可编程的，主片端口号是0x20和0x21，从片端口号是0xa0和0xa1，可以通过这些端口，设置它的工作方式，IMR的内容。

处理器内部有个IF（Interrupt Flag）。IF为0，所有从处理器INTR引脚来的中断都被忽略，IF为1处理器课接受和响应中断。

IF通过cli和sti改变，cli（Clear Interrupt flag）用于清除IF标志，sti（SeT Interrupt flag）用于设置IF标志。

主片IR0引脚优先级最高，IR7优先级最低。如果一个中断正在发生过，来了个优先级更高的中断事件时，允许先暂时终止当前中断处理，先为优先级高的中断服务，这叫中断嵌套

#### 实模式下的中断向量表

处理器可以识别256个中断，理论有256段程序。实模式下，处理器要求将它们入口点集中存放到0x00000开始，到0x003ff结束，共1KB的空间内，这就是中断向量表（Interrupt Vector Table，IVT）。每个中断在中断向量表中占2个字，分别是偏移地址和段地址。

中断发生时，如果外部硬件到处理器之间道路都是畅通的，处理器执行完当前指令后，立即着手为硬件服务。首先响应中断，告诉8259芯片着手处理该终端。接着，让8259芯片把中断号送过来。对8259芯片号引脚对应的中断号进行编程时，不能单独进行，只能以芯片为单位进行。比如，主片中断号从0x08开始，IR0~IR7对应0x08~0x0e。

处理器要做如下工作：

![屏幕截图 2023-03-14 222525](/home/cccmmf/操作系统/x86/chap9/屏幕截图 2023-03-14 222525.png)

#### 实时时钟、CMOS RAM和BCD编码

在外设控制芯片ICH内部，集成了实时时钟电路（Real Time Clock，RTC）和两小块由互补金属氧化物（CMOS）材料组成的静态存储器（CMOS RAM）。实时时钟电路负责计时，日期和时间的数值存储在这块存储器中。实时时钟全天候跳动，即使关闭计算机电源后，它由主板上的一个小电池提供能量。为整台计算机提供一个基准时间，为所有需要时间的软件和硬件服务。除了日期和时间的保存功能外，RTC芯片也提供闹钟和周期性中断功能。日期和时间保存在CMOS RAM中，通常有128字节，其他空间保存整机的配置信息，比如各类硬件的类型和工作参数、开机密码和辅助存储设备的启动顺序等。这些参数修改通常在BIOS SETUP中。RTC芯片由一个振荡频率为32.678kHz的石英晶体振荡器（晶振）驱动，经分频后，用于对CMOS RAM进行每秒一次的时间刷新。

![屏幕截图 2023-03-14 223202](/home/cccmmf/操作系统/x86/chap9/屏幕截图 2023-03-14 223202.png)

![屏幕截图 2023-03-14 223227](/home/cccmmf/操作系统/x86/chap9/屏幕截图 2023-03-14 223227.png)

![屏幕截图 2023-03-14 223333](/home/cccmmf/操作系统/x86/chap9/屏幕截图 2023-03-14 223333.png)

![屏幕截图 2023-03-14 223403](/home/cccmmf/操作系统/x86/chap9/屏幕截图 2023-03-14 223403.png)

#### 初始化8259、RTC和中断向量表

当处理器执行任何一条改变栈段寄存器SS的指令时，将会在下一条指令执行完期间禁止中断。因为栈很重要，除了有栈段寄存器，还有栈指针，大多数时候先改变段寄存器SS，再改变栈指针SP。

RTC芯片中断信号，通过中断控制器8259从片的第1个中断引脚IR0。计算机启动期间，BIOS会初始化中断控制器，主片中断号默认从0x08开始，从片中断号从0x70开始。所以RTC默认终端号是0x70。

![屏幕截图 2023-03-15 175511](/home/cccmmf/操作系统/x86/chap9/屏幕截图 2023-03-15 175511.png)

![屏幕截图 2023-03-15 175754](/home/cccmmf/操作系统/x86/chap9/屏幕截图 2023-03-15 175754.png)

![屏幕截图 2023-03-15 182350](/home/cccmmf/操作系统/x86/chap9/屏幕截图 2023-03-15 182350.png)

![屏幕截图 2023-03-15 182921](/home/cccmmf/操作系统/x86/chap9/屏幕截图 2023-03-15 182921.png)

![屏幕截图 2023-03-15 182940](/home/cccmmf/操作系统/x86/chap9/屏幕截图 2023-03-15 182940.png)

![屏幕截图 2023-03-15 183713](/home/cccmmf/操作系统/x86/chap9/屏幕截图 2023-03-15 183713.png)

![屏幕截图 2023-03-15 183958](/home/cccmmf/操作系统/x86/chap9/屏幕截图 2023-03-15 183958.png)

![屏幕截图 2023-03-15 184714](/home/cccmmf/操作系统/x86/chap9/屏幕截图 2023-03-15 184714.png)





